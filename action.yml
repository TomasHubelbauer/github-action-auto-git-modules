name: 'Auto Git Modules'
description: 'A GitHub Action for automatically syncing changes to .gitmodules with the rest of the Git repository'
runs:
  using: 'composite'
  steps:
    - name: Check out repository code
      uses: actions/checkout@main
      with:
        # Note that `submodules: recursive` would fail if added to `.gitmoodules` by hand
        ref: main

    - name: Run tests
      run: |
        echo "echo test $CI test"
      shell: bash

    - name: Run the script
      run: node ${{ env.GITHUB_ACTION_PATH }}
      shell: bash
      env:
        ACTIONS_STEP_DEBUG: true

    - name: Sync submodules
      run: git -c protocol.file.allow=always submodule update --init --recursive --remote
      shell: bash

    - name: Print changes
      run: git status
      shell: bash

    - name: Commit and push the change to the GitHub repository from the agent
      run: |
        # Configure Git for the push from the workflow to the repository
        # (This is needed even with the workflow PAT)
        # These credentials will make the commit associate with the GitHub Actions service account
        git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git config --global user.name "github-actions[bot]"
      shell: bash

    - name: Stage the changes resulting from the above steps
      run: git add *
      shell: bash

    - name: Bail if there are no changes staged to commit
      id: bail
      continue-on-error: true
      run: |
        git status
        if git diff-index --quiet HEAD --; then
          echo "bail=true" >> $GITHUB_OUTPUT
        else
          echo "bail=false" >> $GITHUB_OUTPUT
        fi
      shell: bash

    - name: Commit the staged changes to the workflow repository
      if: ${{steps.bail.outputs.bail == 'false'}}
      run: git commit -m "Commit submodules sync changes from the workflow"
      shell: bash

    - name: Rebase if the branch has changed meanwhile or fail on conflicts
      if: ${{steps.bail.outputs.bail == 'false'}}
      run: git pull --rebase
      shell: bash

    - name: Push the commit to the workflow repository
      if: ${{steps.bail.outputs.bail == 'false'}}
      run: git push
      shell: bash
